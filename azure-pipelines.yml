trigger:
  branches:
    include:
      - main
  paths:
    include: 
      - pipeline-samples/**
    exclude:
      - 01-Project/**
      - 02-Project/**
      - 03-Project/**
      - 04-Project/**
pool:
  name: 'self-hosted'
stages:
  - stage: validate
    jobs:
      - job: terraform_validate
        steps:
          - task: TerraformInstaller@1 # installs terraform
            inputs:
              terraformVersion: '1.6.6'
          - task: TerraformTask@5 # terraform init
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/pipeline-sample/'
              backendServiceArm: 'adomanagedidentity'
              backendAzureRmResourceGroupName: 'tf-backend-rg'
              backendAzureRmStorageAccountName: 'tfazbackendstore2709'
              backendAzureRmContainerName: 'tf-backend'
              backendAzureRmKey: 'statefile.tfstate'
          - task: TerraformTask@5
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/pipeline-sample/'
  - stage: deploy
    jobs:
      - job: terraform_deploy
        steps:
          - task: TerraformTask@5 # terraform plan
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/pipeline-sample/'
              commandOptions: '-var-file="vars.tfvars"'
              environmentServiceNameAzureRM: 'adomanagedidentity'
          - task: TerraformTask@5 # terraform apply
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/pipeline-sample/'
              commandOptions: '-var-file="vars.tfvars" -auto-approve'
              environmentServiceNameAzureRM: 'adomanagedidentity'